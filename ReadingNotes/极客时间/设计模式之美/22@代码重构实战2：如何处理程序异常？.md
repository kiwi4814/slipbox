+++
title = "代码重构实战2：如何处理程序异常？"
date = 2022-06-14 10:18:49
slug = "/id-generator-exception"
draft = false
tags = ["阅读笔记","设计模式"]
categories = ["阅读笔记"]
series = ["设计模式之美"]
toc = false

+++

我们可以把函数的运行结果分成两类，一类是预期的结果，也就是函数在正常情况下输出的结果，另一类是非预期的结果，也就是函数在出错情况下输出的结果。



在正常情况下，函数返回的数据非常明确，但是在异常的时候，却有很多种方式，比如异常对象Exception、NULL、特殊值（-1等）、空对象等。



每一种异常返回的数据类型，都有各自的特点和使用场景，但是根据实际的情况返回什么样的数据类型并不容易判断。以ID生成器为例，在本机名获取失败的时候，generate函数该返回什么呢？是异常、空字符、还是NULL，亦或者是其他特殊值？



对于函数的异常处理，是我们在函数编写过程中时刻都要考虑的。今天就来聊一聊如何设计函数在异常情况下的返回数据类型。



## 函数出错该返回什么？

### 1. 返回错误码

在C语言中没有异常这样的语法机制，因此，返回错误码便是最常用的出错处理方式。而在Java、Python等比较新的编程语言中，我们都用异常来处理函数出错的情况，很少会用到错误码。



实际上，如果你熟悉的编程语言中有异常这种语法机制，那就尽量不要使用错误码。异常相对于错误码，有诸多方面的优势，比如可以携带更多的错误信息（exception 中可以有 message、stack trace 等信息）等。

### 2. 返回NULL值

在多数编程语言中，我们用NULL来表示“不存在”这种语义。但是很多人不建议返回NULL，因为：

- 如果在使用的时候忘记做非空判断，就会出现空指针异常
- 代码中会充斥大量的NULL值判断逻辑，影响可读性

但实际上，对于以 get、find、select、search、query 等单词开头的查找函数来说，数据不存在，并非一种异常情况，这是一种正常行为。所以，返回代表不存在语义的 NULL 值比返回异常更加合理。

### 3. 返回空对象

刚刚我们讲到，返回 NULL 值有各种弊端。应对这个问题有一个比较经典的策略，那就是应用空对象设计模式（Null Object Design Pattern）。



我们今天来讲两种比较简单、比较特殊的空对象，那就是空字符串和空集合。当函数返回的数据是字符串类型或者集合类型的时候，我们可以用空字符串或空集合替代 NULL 值，来表示不存在的情况。这样，我们在使用函数的时候，就可以不用做 NULL 值判断。

### 4. 抛出异常对象

尽管前面讲了很多函数出错的返回数据类型，但是，最常用的函数出错处理方式是抛出异常。异常有两种类型：受检异常和非受检异常。

对于应该用受检异常还是非受检异常，网上的争论有很多，但也并没有一个非常强有力的理由，说明一个就一定比另一个更好。所以，我们只需要根据团队的开发习惯，在同一个项目中，制定统一的异常处理规范即可。

对于函数抛出的异常，我们有三种处理方法：直接吞掉、直接往上抛出、包裹成新的异常抛出。



当我们面对函数抛出异常的时候，应该选择上面的哪种处理方式呢？我总结了下面三个参考原则：

- 如果 func1() 抛出的异常是可以恢复，且 func2() 的调用方并不关心此异常，我们完全可以在 func2() 内将 func1() 抛出的异常吞掉；
- 如果 func1() 抛出的异常对 func2() 的调用方来说，也是可以理解的、关心的 ，并且在业务概念上有一定的相关性，我们可以选择直接将 func1 抛出的异常 re-throw；
- 如果 func1() 抛出的异常太底层，对 func2() 的调用方来说，缺乏背景去理解、且业务概念上无关，我们可以将它重新包装成调用方可以理解的新异常，然后 re-throw。

总之，是否往上继续抛出，要看上层代码是否关心这个异常。关心就将它抛出，否则就直接吞掉。是否需要包装成新的异常抛出，看上层代码是否能理解这个异常、是否业务相关。如果能理解、业务相关就可以直接抛出，否则就封装成新的异常抛出。



## 实战：ID生成器中的程序异常处理

### 重构 generate() 函数

首先，我们来看，对于 generate() 函数，如果本机名获取失败，函数返回什么？这样的返回值是否合理？



在异常情况下，返回上面两种特殊的 ID 数据格式，这样的做法是否合理呢？这个其实很难讲，我们要看具体的业务是怎么设计的。不过，我更倾向于明确地将异常告知调用者。所以，这里最好是抛出受检异常，而非特殊值。



### 重构 getLastFieldOfHostName() 函数

